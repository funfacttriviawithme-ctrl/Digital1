<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control Panel | Digital Informatic</title>
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#8b5cf6">
    <meta name="msapplication-TileColor" content="#050508">
    <meta name="theme-color" content="#050508">
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --accent: #8b5cf6;
            --accent-soft: rgba(139, 92, 246, 0.1);
            --bg-deep: #050508;
            --surface: rgba(18, 18, 26, 0.7);
            --border: rgba(255, 255, 255, 0.06);
        }

        body {
            background-color: var(--bg-deep);
            color: #e2e8f0;
            font-family: 'Lexend', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            /* Fitur Transition: Smooth Page Fade-In */
            opacity: 0;
            transition: opacity 0.8s;
        }

        .mono { font-family: 'Fira Code', monospace; }

        /* Efek Latar Belakang */
        .glow-orb {
            position: fixed;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            filter: blur(80px);
            pointer-events: none;
        }

        .bg-grid {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Glass Panel */
        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        /* Sidebar Responsive */
        .sidebar {
            width: 280px;
            background: rgba(10, 10, 15, 0.98);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            left: 0; top: 0; z-index: 100;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: #94a3b8;
            border-radius: 0.75rem;
            margin: 0.25rem 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent);
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            transition: margin 0.4s ease;
        }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1.25rem; }
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                backdrop-filter: blur(4px);
                z-index: 90;
            }
            .sidebar-overlay.active { display: block; }
        }

        /* Tactical Elements */
        .btn-shadow {
            background: var(--accent);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.2);
        }

        .btn-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            background: #7c3aed;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active { display: flex; }

        .modal-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2.5rem;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 2rem;
        }

        /* Input Fields */
        .tactical-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.85rem 1.25rem;
            color: white;
            font-size: 0.85rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .tactical-input:focus {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        .password-container {
            position: relative;
            width: 100%;
        }

        /* Fitur Ikon Mata */
        .password-toggle-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #475569;
            cursor: pointer;
            z-index: 10;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e1e2e; border-radius: 10px; }
    </style>
</head>
<body class="overflow-x-hidden">
    <div class="glow-orb" style="top: -10%; left: -10%;"></div>
    <div class="glow-orb" style="bottom: -10%; right: -10%; background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);"></div>
    <div class="bg-grid"></div>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <div class="p-8 mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-900/40 border border-violet-400/20">
                    <i class="fas fa-crown text-white"></i>
                </div>
                <div>
                    <!-- Sidebar Title: Overlord / minion -->
                    <h1 id="sidebarTitle" class="font-black text-lg tracking-tighter uppercase italic text-white">SYSTEM</h1>
                    <p class="mono text-[8px] text-slate-500 tracking-widest uppercase">Admin_v4.2.0</p>
                </div>
            </div>
        </div>

        <div class="space-y-1">
            <div class="nav-link active" onclick="switchTab('overview')">
                <i class="fas fa-th-large w-5"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Overview</span>
            </div>
            <div class="nav-link" onclick="switchTab('client-database')">
                <i class="fas fa-users w-5"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Kelola User</span>
            </div>
            <div class="nav-link" onclick="switchTab('waiting-room')">
                <i class="fas fa-clock w-5"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Waiting Room</span>
            </div>
            <div class="nav-link" onclick="switchTab('admin-logs')">
                <i class="fas fa-shield-halved w-5 text-violet-400"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Admin Logs</span>
            </div>
            <div class="nav-link" onclick="switchTab('admin-settings')">
                <i class="fas fa-gear w-5"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Pengaturan</span>
            </div>
            <div class="nav-link mt-8" onclick="handleLogout()">
                <i class="fas fa-power-off w-5 text-red-500"></i>
                <span class="text-sm font-semibold uppercase tracking-wider">Logout</span>
            </div>
        </div>

        <div class="absolute bottom-8 left-0 w-full px-6">
            <div class="glass-panel p-4 rounded-2xl bg-violet-600/5 border-violet-500/10">
                <div class="flex items-center gap-3">
                    <div id="avatarCircle" class="w-8 h-8 rounded-full bg-violet-500 flex items-center justify-center text-[10px] font-bold text-white">AD</div>
                    <div class="overflow-hidden">
                        <p id="operatorDisplay" class="text-[10px] font-bold text-white uppercase truncate">Main Admin</p>
                        <p id="roleDisplay" class="mono text-[8px] text-green-500 uppercase tracking-tighter">Node: Secure_Link</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="flex justify-between items-center mb-10 gap-4">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden w-11 h-11 glass-panel flex items-center justify-center text-violet-500 rounded-xl">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h2 id="tabTitle" class="text-xl md:text-2xl font-black italic uppercase tracking-tighter text-white leading-tight">System Overview</h2>
                    <p class="mono text-[8px] md:text-[10px] text-slate-500 uppercase tracking-widest">Intelligence Command Interface</p>
                </div>
            </div>
        </header>

        <!-- TAB: OVERVIEW -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-10">
                <div class="glass-panel p-6 md:p-8 rounded-3xl">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-12 h-12 bg-violet-600/10 rounded-2xl flex items-center justify-center text-violet-500 border border-violet-500/20">
                            <i class="fas fa-user-astronaut text-xl"></i>
                        </div>
                        <span class="mono text-[9px] text-slate-500 uppercase">Live_Sesi</span>
                    </div>
                    <p class="mono text-[10px] text-slate-500 uppercase tracking-widest mb-1">Total Sesi Aktif</p>
                    <h3 class="text-3xl md:text-4xl font-black text-white tracking-tighter" id="totalUsersCount">0</h3>
                </div>
                <div class="glass-panel p-6 md:p-8 rounded-3xl border-amber-500/20 cursor-pointer hover:bg-amber-500/5" onclick="switchTab('waiting-room')">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-12 h-12 bg-amber-600/10 rounded-2xl flex items-center justify-center text-amber-500 border border-amber-500/20">
                            <i class="fas fa-inbox text-xl"></i>
                        </div>
                        <span class="w-2.5 h-2.5 rounded-full bg-amber-500 animate-ping"></span>
                    </div>
                    <p class="mono text-[10px] text-slate-500 uppercase tracking-widest mb-1">Antrian Baru</p>
                    <h3 class="text-3xl md:text-4xl font-black text-amber-500 tracking-tighter" id="totalPendingCount">0</h3>
                </div>
            </div>

            <div class="flex">
                <button onclick="openAddModal()" class="btn-shadow px-10 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center gap-3 w-full sm:w-auto justify-center">
                    <i class="fas fa-plus-circle"></i> Inisialisasi User Baru
                </button>
            </div>
        </div>

        <!-- TAB: CLIENT DATABASE -->
        <div id="client-database" class="tab-content">
            <div class="glass-panel rounded-3xl overflow-hidden">
                <div class="p-6 md:p-8 border-b border-white/5 flex flex-col md:flex-row justify-between gap-6">
                    <h4 class="font-bold text-sm uppercase tracking-widest flex items-center gap-3">
                        <i class="fas fa-database text-violet-500"></i> Database Klien
                    </h4>
                    <div class="relative w-full md:w-80">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                        <input type="text" id="userSearchInput" onkeyup="filterUsers()" placeholder="Cari nama atau username..." class="tactical-input !pl-10 !py-2.5">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-white/5 text-[9px] text-slate-500 uppercase mono">
                            <tr>
                                <th class="p-5">Username</th>
                                <th class="p-5">Nama Subjek</th>
                                <th class="p-5 text-center">Layanan</th>
                                <th class="p-5 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="text-xs text-slate-300"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: WAITING ROOM -->
        <div id="waiting-room" class="tab-content">
            <div id="pendingContainer" class="grid grid-cols-1 gap-4 max-w-4xl mx-auto"></div>
        </div>

        <!-- TAB: ADMIN LOGS -->
        <div id="admin-logs" class="tab-content">
            <div class="glass-panel rounded-3xl overflow-hidden">
                <div class="p-6 md:p-8 border-b border-white/5 flex justify-between items-center">
                    <h4 class="font-bold text-sm uppercase tracking-widest text-violet-400">
                        <i class="fas fa-shield-halved"></i> Access History
                    </h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-white/5 text-[9px] text-slate-500 uppercase mono">
                            <tr>
                                <th class="p-5 text-center">Timestamp</th>
                                <th class="p-5">Operator ID</th>
                                <th class="p-5">IP_Node</th>
                            </tr>
                        </thead>
                        <tbody id="adminLogTableBody" class="text-xs text-slate-300"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: ADMIN SETTINGS -->
        <div id="admin-settings" class="tab-content">
            <!-- Tampilan untuk Superadmin -->
            <div id="superadminView" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="glass-panel p-8 rounded-3xl">
                        <h4 class="font-bold uppercase tracking-widest text-sm mb-6 flex items-center gap-3">
                            <i class="fas fa-user-plus text-violet-500"></i> Tambah Admin
                        </h4>
                        <form id="adminUserForm" class="space-y-4">
                            <div class="space-y-1.5">
                                <label class="mono text-[8px] text-slate-500 uppercase tracking-widest ml-2">Admin Identifier</label>
                                <input type="text" id="adminNewUsername" class="tactical-input" placeholder="ID-ADMIN-XX" required>
                            </div>
                            <div class="space-y-1.5">
                                <label class="mono text-[8px] text-slate-500 uppercase tracking-widest ml-2">Security Key</label>
                                <div class="password-container">
                                    <input type="password" id="adminNewPassword" class="tactical-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                                    <i class="fas fa-eye password-toggle-icon" onclick="togglePassVisibility('adminNewPassword')"></i>
                                </div>
                            </div>
                            <button type="submit" class="btn-shadow w-full py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest mt-4">
                                Authorize Operator
                            </button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="glass-panel rounded-3xl overflow-hidden">
                        <div class="p-6 md:p-8 border-b border-white/5">
                            <h4 class="font-bold text-sm uppercase tracking-widest">Daftar Admin Aktif</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-white/5 text-[9px] text-slate-500 uppercase mono">
                                    <tr>
                                        <th class="p-5">ID Admin</th>
                                        <th class="p-5 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTableBody" class="text-xs text-slate-300"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tampilan untuk Admin Biasa -->
            <div id="adminViewOnly" class="hidden glass-panel p-12 rounded-3xl text-center">
                <i class="fas fa-lock text-slate-700 text-5xl mb-6"></i>
                <h4 class="text-xl font-black uppercase italic text-slate-500">Akses Terbatas</h4>
                <p class="text-slate-600 mono text-xs mt-2">Hanya Overlord (Superadmin) yang dapat mengelola kredensial operator.</p>
            </div>
        </div>
    </main>

    <!-- MODAL: ADD/EDIT USER -->
    <div id="addUserModal" class="modal">
        <div class="modal-card">
            <button onclick="closeModal('addUserModal')" class="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors p-2"><i class="fas fa-times text-lg"></i></button>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-violet-600/10 rounded-2xl flex items-center justify-center text-violet-500 mx-auto mb-4 border border-violet-500/20">
                    <i class="fas fa-user-gear text-2xl"></i>
                </div>
                <h3 id="modalTitle" class="text-xl md:text-2xl font-black uppercase italic tracking-tighter text-white">Inisialisasi User</h3>
            </div>
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                <input type="hidden" id="pendingId">
                <button type="button" onclick="generateCredentials()" class="w-full py-3 bg-violet-600/10 border border-dashed border-violet-500/30 rounded-xl text-violet-400 font-bold uppercase text-[9px] hover:bg-violet-600/20 mb-2 flex items-center justify-center gap-2">
                    <i class="fas fa-wand-magic-sparkles"></i> Auto Generate
                </button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="username" class="tactical-input" placeholder="USERNAME" required>
                    <div class="password-container">
                        <input type="password" id="password" class="tactical-input" placeholder="PASSWORD" required>
                        <i class="fas fa-eye password-toggle-icon" onclick="togglePassVisibility('password')"></i>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" class="tactical-input" placeholder="NAMA LENGKAP" required>
                    <input type="tel" id="phoneNumberTarget" class="tactical-input" placeholder="NOMOR HP" required>
                </div>
                <select id="service" class="tactical-input bg-[#0a0a0f]">
                    <option value="PEMANTAUAN DASAR">DASAR</option>
                    <option value="SINKRONISASI MENENGAH" selected>MENENGAH</option>
                    <option value="SINKRONISASI MENDALA">MENDALAM</option>
                </select>
                <button type="submit" id="submitBtn" class="btn-shadow w-full py-4 rounded-2xl font-black uppercase text-[10px] mt-6">Deploy Metadata</button>
            </form>
        </div>
    </div>

    <script>

        const role = localStorage.getItem('admin_role');
        const adminId = localStorage.getItem('admin_id');

        if (!role || !adminId) {
            window.location.href = '/admin/login.html';
    }

        // Transition: Smooth Page Fade-In
        window.onload = () => document.body.style.opacity = '1';

        // ============ API CONFIGURATION ============
        const API_BASE_URL = window.location.origin;
        const APP_ID = 'digital-backend-prod';

        // ============ FIREBASE CONFIG ============
        let firebaseInitialized = false;
        let db, auth;

        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase initialized');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase not available, using API only');
        }

        // ============ APPLICATION STATE ============
        let currentUsers = [];
        let currentPendings = [];
        let adminUsers = [];
        let isAuthReady = false;

        // ============ USER MANAGEMENT ============
        const userRole = localStorage.getItem('admin_role') || 'admin';
        const operatorID = localStorage.getItem('admin_id') || 'Unknown';

        // ============ API FUNCTIONS ============
        async function loadPendingRequests() {
  try {
    console.log('üì° Loading pending requests...');
    const response = await fetch(`${API_BASE_URL}/api/pending`);

    if (!response.ok) throw new Error(`API error: ${response.status}`);

    const result = await response.json();
    console.log('‚úÖ Pending API response:', result);

    if (result.success) {
      currentPendings = result.data || [];
      document.getElementById('totalPendingCount').textContent =
        result.count || currentPendings.length;

      renderPendingList(currentPendings);
      console.log(`üìä Loaded ${currentPendings.length} pending requests`);
      return currentPendings;
    } else {
      throw new Error(result.error || 'API returned success: false');
    }
  } catch (error) {
    console.error('‚ùå API load pending error:', error);

    // fallback firebase (kalau kamu masih butuh)
    if (firebaseInitialized && db) {
      console.log('üîÑ Falling back to Firebase...');
      const pendingPath = `artifacts/${APP_ID}/public/data/pending_requests`;

      db.collection(pendingPath).onSnapshot((snapshot) => {
        currentPendings = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
          createdAt: doc.data().createdAt?.toDate() || new Date(),
        }));

        document.getElementById('totalPendingCount').textContent =
          currentPendings.length;

        renderPendingList(currentPendings);
      });
    }

    return [];  // Akhir dari catch block
  }
}

        
async function loadClients() {
  try {
    console.log('üì° Loading clients...');
    const response = await fetch(`${API_BASE_URL}/api/clients`);

    if (!response.ok) throw new Error(`API error: ${response.status}`);

    const result = await response.json();
    console.log('‚úÖ Clients API response:', result);

    if (result.success) {
      currentUsers = result.data || [];
      document.getElementById('totalUsersCount').textContent = result.count || currentUsers.length;
      renderUserList(currentUsers);
      console.log(`üìä Loaded ${currentUsers.length} clients`);
      return currentUsers;
    } else {
      throw new Error(result.error || 'API returned success: false');
    }
  } catch (error) {
    console.error('‚ùå API load clients error:', error);
    return [];
  }
}


async function loadAdminLogs() {
  try {
    if (userRole !== 'superadmin') return [];

    console.log('üì° Loading admin logs...');
    const response = await fetch(`${API_BASE_URL}/api/admin/logs?limit=50`);

    if (!response.ok) {
      if (response.status === 403) {
        console.log("‚õî Admin logs forbidden");
        return [];
      }
      throw new Error(`API error: ${response.status}`);
    }

    const result = await response.json();
    console.log("‚úÖ Admin logs response:", result);

    // ‚úÖ kalau response bentuknya {success:true, data:[...]}
    const logs = result.logs || [];

    renderAdminLogs(logs);
    return logs;

  } catch (error) {
    console.error("‚ùå API load admin logs error:", error);
    return [];
  }
}


async function loadAdminUsers() {
  try {
    if (userRole !== "superadmin") return;

    console.log("üì° Loading admin users...");
    const response = await fetch(`${API_BASE_URL}/api/admin/users/all`);

    if (!response.ok) throw new Error(`API error: ${response.status}`);

    const result = await response.json();
    console.log("‚úÖ Admin users response:", result);

    const admins = result.admins || [];
    adminUsers = admins;
    renderAdminList(admins);

    return admins;
  } catch (error) {
    console.error("‚ùå API load admin users error:", error);
    return [];
  }
}

        // ============ RENDER FUNCTIONS ============
        function renderUserList(data) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = data.length ? '' : '<tr><td colspan="4" class="p-10 text-center text-slate-600 mono uppercase text-[10px]">No active links</td></tr>';
            
            data.forEach(user => {
                tbody.innerHTML += `
                    <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-all">
                        <td class="p-5 mono text-violet-400 font-bold">${user.username || 'N/A'}</td>
                        <td class="p-5 font-bold text-white uppercase tracking-tight">${user.name || 'N/A'}</td>
                        <td class="p-5 text-center"><span class="px-3 py-1 bg-violet-600/10 text-violet-500 rounded-full font-black text-[8px] border border-violet-500/20">${user.service || 'N/A'}</span></td>
                        <td class="p-5 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="openEditModal('${user.id}')" class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center text-slate-500 hover:text-violet-500"><i class="fas fa-pen text-[11px]"></i></button>
                                <button onclick="deleteUser('${user.id}')" class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center text-slate-500 hover:text-red-500"><i class="fas fa-trash-can text-[11px]"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function renderAdminList(admins) {
  const tbody = document.getElementById("adminTableBody");
  if (!tbody) return;

  tbody.innerHTML = admins.length
    ? ""
    : `<tr><td colspan="2" class="p-10 text-center text-slate-600 mono text-[10px] uppercase">
        No admin found
      </td></tr>`;

  admins.forEach((a) => {
    tbody.innerHTML += `
      <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-all">
        <td class="p-5 mono text-violet-400 font-bold uppercase">${a.username || "N/A"}</td>
        <td class="p-5 text-right">
          <button onclick="deleteAdmin('${a.id}')" 
            class="px-4 py-2 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl font-black text-[9px] hover:bg-red-500 hover:text-black transition-all uppercase tracking-widest">
            Cabut
          </button>
        </td>
      </tr>
    `;
  });
}

        function renderAdminLogs(logs) {
            const tbody = document.getElementById("adminLogTableBody");
            if (!tbody) return;

            // ‚úÖ pastiin logs array
            if (!Array.isArray(logs)) logs = [];

            tbody.innerHTML = logs.length
                ? ""
                : `<tr><td colspan="3" class="p-10 text-center text-slate-600 mono text-[10px] uppercase">
                    No logs found
                    </td></tr>`;

            logs.slice(0, 15).forEach((log) => {
                const date = log.timestamp ? new Date(log.timestamp).toLocaleString("id-ID") : "...";

            tbody.innerHTML += `
                <tr class="border-b border-white/5">
                <td class="p-5 text-center mono text-[10px] text-slate-500">${date}</td>
                <td class="p-5 font-bold text-white mono text-[10px]">${log.adminId || "-"}</td>
                <td class="p-5 mono text-[10px] text-slate-400 uppercase">${log.ipNode || "Local"}</td>
                </tr>`;
        });
    }

        function renderPendingList(pendings) {
            const pContainer = document.getElementById('pendingContainer');
            pContainer.innerHTML = pendings.length ? '' : '<p class="p-10 text-center text-slate-600 mono text-[9px] uppercase tracking-widest bg-white/5 rounded-3xl border border-dashed border-white/5">Antrian saat ini kosong</p>';
            
            pendings.forEach(p => {
                pContainer.innerHTML += `
                    <div class="glass-panel p-6 rounded-3xl flex justify-between items-center group hover:border-amber-500/30 transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-11 h-11 rounded-2xl bg-amber-500/10 flex items-center justify-center text-amber-500 border border-amber-500/20">
                                <i class="fas fa-inbox text-sm"></i>
                            </div>
                            <div>
                                <p class="font-bold text-white uppercase">${p.name}</p>
                                <p class="mono text-[8px] text-slate-500 uppercase tracking-widest mt-1">Target: +${p.phoneNumberTarget}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="processPending('${p.id}')" class="px-5 py-2.5 bg-amber-500/10 text-amber-500 border border-amber-500/20 rounded-xl font-black text-[9px] hover:bg-amber-500 hover:text-black transition-all uppercase tracking-widest">Otorisasi</button>
                            <button onclick="deletePending('${p.id}')" class="w-11 h-11 rounded-xl border border-white/5 flex items-center justify-center text-slate-600 hover:text-red-500"><i class="fas fa-trash-can text-sm"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // ============ CORE FUNCTIONS ============
        async function initApp() {
            console.log('üöÄ Initializing dashboard...');
            
            // Get role from URL or localStorage
            const role = localStorage.getItem('admin_role');
            const adminId = localStorage.getItem('admin_id');

            if (!role || !adminId) {
                window.location.href = '/admin/login.html';
                return;
            }

            
            // Apply role to sidebar
            const titleEl = document.getElementById('sidebarTitle');
            if (role === 'superadmin') {
                titleEl.innerText = "OVERLORD";
                titleEl.classList.add('text-violet-500');
                document.getElementById('superadminView').classList.remove('hidden');
                
                // Load admin-specific data
                await loadAdminLogs();
                await loadAdminUsers();
            } else {
                titleEl.innerText = "BUDAK";
                titleEl.classList.add('text-slate-500');
                document.getElementById('adminViewOnly').classList.remove('hidden');
            }
            
            document.getElementById('operatorDisplay').textContent = adminId;
            document.getElementById('roleDisplay').textContent = `Node: ${role.toUpperCase()}`;
            
            try {
                // Firebase auth if token exists
                const firebaseToken = localStorage.getItem('firebase_token');
                if (firebaseToken && firebaseInitialized) {
                    await auth.signInWithCustomToken(firebaseToken);
                    console.log('‚úÖ Firebase auth successful');
                    isAuthReady = true;
                }
            } catch (err) { 
                console.error("Auth error:", err);
            }
            
            // Load data
            await loadPendingRequests();
            await loadClients();
            
            console.log('‚úÖ Dashboard initialized');
        }

        // ============ UI FUNCTIONS ============
        function togglePassVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => { 
                if(link.getAttribute('onclick').includes(tabId)) link.classList.add('active'); 
            });
            
            const titles = { 
                'overview': 'System Overview', 
                'client-database': 'Control Database', 
                'waiting-room': 'Waiting Room', 
                'admin-logs': 'Access History', 
                'admin-settings': 'Administrator Settings' 
            };
            document.getElementById('tabTitle').innerText = titles[tabId];
            
            if (window.innerWidth < 1024) toggleSidebar(false);
        }

        function toggleSidebar(force) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (force === false) { 
                sidebar.classList.remove('active'); 
                overlay.classList.remove('active'); 
            } else { 
                sidebar.classList.toggle('active'); 
                overlay.classList.toggle('active'); 
            }
        }

        async function handleLogout() { 
            if(confirm('Akhiri sesi administrasi?')) { 
                localStorage.clear(); 
                location.href = '/admin/login'; 
            } 
        }

        function openEditModal(id) {
            const user = currentUsers.find(u => u.id === id);
            if (!user) return;

            // Buka modal edit user tanpa mereset data
            document.getElementById("modalTitle").innerText = "Edit User";
            document.getElementById("editUserId").value = user.id;

            document.getElementById("username").value = user.username || "";
            document.getElementById("password").value = user.plainPassword || ""; // Kalau password disimpan
            document.getElementById("password").type = "text";
            document.getElementById("name").value = user.name || "";
            document.getElementById("phoneNumberTarget").value = user.phoneNumberTarget || "";
            document.getElementById("service").value = user.service || "SINKRONISASI MENENGAH";

            document.getElementById("pendingId").value = ""; // Pastikan modal bukan untuk pending
            document.getElementById("addUserModal").classList.add("active");  // Buka modal
        }

        function openAddModal() {
            document.getElementById("modalTitle").innerText = "Proses Antrian";
            document.getElementById("editUserId").value = "";
            document.getElementById("addUserModal").classList.add("active");
        }

        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
        }

        function generateCredentials() { 
            const r = (l) => Array.from({length: l}, () => "ABC123".charAt(Math.floor(Math.random() * 6))).join(''); 
            document.getElementById('username').value = "DI-" + r(4); 
            document.getElementById('password').value = r(8); 
        }

        function filterUsers() {
            const input = document.getElementById('userSearchInput').value.toLowerCase();
            const filtered = currentUsers.filter(user => 
                (user.username && user.username.toLowerCase().includes(input)) || 
                (user.name && user.name.toLowerCase().includes(input))
            );
            renderUserList(filtered);
        }

        // ============ FORM HANDLERS ============
        document.getElementById('adminUserForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (userRole !== 'superadmin') {
                alert('Hanya Superadmin yang dapat menambah admin!');
                return;
            }
            
            const username = document.getElementById('adminNewUsername').value;
            const password = document.getElementById('adminNewPassword').value;
            
            try {
                console.log('üìù Adding new admin:', username);
                
                const response = await fetch(`${API_BASE_URL}/api/admin/users/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        role: 'admin',
                        createdBy: operatorID
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Admin berhasil ditambahkan!');
                    document.getElementById('adminUserForm').reset();
                    loadAdminUsers();
                } else {
                    throw new Error(data.error || 'Failed to add admin');
                }
            } catch (error) {
                console.error('‚ùå Add admin error:', error);
                alert('‚ùå Gagal menambah admin: ' + error.message);
            }
        };

        // ============ CRUD OPERATIONS ============
        async function deleteAdmin(id) { 
            if (userRole !== 'superadmin') {
                alert('Hanya Superadmin yang dapat menghapus admin!');
                return;
            }
            
            if(!confirm('Cabut otorisasi admin?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId: operatorID })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Admin berhasil dihapus!');
                    loadAdminUsers();
                } else {
                    throw new Error(data.error || 'Failed to delete admin');
                }
            } catch (error) {
                console.error('‚ùå Delete admin error:', error);
                alert('‚ùå Gagal menghapus admin: ' + error.message);
            }
        }

        async function deleteUser(id) { 
            if(!confirm('Hapus akses user?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/clients/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId: operatorID })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ User berhasil dihapus!');
                    loadClients();
                } else {
                    throw new Error(data.error || 'Failed to delete user');
                }
            } catch (error) {
                console.error('‚ùå Delete user error:', error);
                alert('‚ùå Gagal menghapus user: ' + error.message);
            }
        }

        async function deletePending(id) { 
            if(!confirm('Abaikan antrian?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/pending/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId: operatorID })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Antrian berhasil dihapus!');
                    loadPendingRequests();
                } else {
                    throw new Error(data.error || 'Failed to delete pending');
                }
            } catch (error) {
                console.error('‚ùå Delete pending error:', error);
                alert('‚ùå Gagal menghapus antrian: ' + error.message);
            }
        }

        window.processPending = function(id) {
  const p = currentPendings.find(x => x.id === id);
  if (!p) return alert("Pending tidak ditemukan");

  openAddModal();

  document.getElementById('name').value = p.name || "";
  document.getElementById('phoneNumberTarget').value = p.phoneNumberTarget || "";
  document.getElementById('service').value = p.service || "SINKRONISASI MENENGAH";
  document.getElementById('pendingId').value = p.id;
}

        // Handle add/edit user form
        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn.dataset.loading === "true") return; // cegah spam klik
            submitBtn.dataset.loading = "true";
            submitBtn.disabled = true;
            submitBtn.style.opacity = "0.6";
            submitBtn.innerText = "PROCESSING...";

            const userId = document.getElementById('editUserId').value;
            const pendingId = document.getElementById('pendingId').value
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const phoneNumberTarget = document.getElementById('phoneNumberTarget').value;
            const service = document.getElementById('service').value;
            
            try {

if (pendingId) {
  // ‚úÖ PROCESS PENDING
  console.log('üîÑ Processing pending:', pendingId);

  const response = await fetch(`${API_BASE_URL}/api/pending/${pendingId}/process`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      password,
      adminId: operatorID,
      name,
      phoneNumberTarget,
      service
    })
  });

  const data = await response.json();

  if (response.ok) {
    alert("‚úÖ Client berhasil ditambahkan dari antrian!");
    closeModal("addUserModal");
    loadPendingRequests();
    loadClients();
  } else {
    throw new Error(data.error || "Failed to process pending");
  }
}

else if (userId) {
  // ‚úÖ UPDATE CLIENT
  console.log("‚úèÔ∏è Updating client:", userId);

  const response = await fetch(`${API_BASE_URL}/api/clients/${userId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      password,
      name,
      phoneNumberTarget,
      service,
      adminId: operatorID
    })
  });

  const data = await response.json();

  if (response.ok) {
    alert("‚úÖ Client berhasil diupdate!");
    closeModal("addUserModal");
    loadClients();
  } else {
    throw new Error(data.error || "Failed to update client");
  }
}

else {
  // ‚úÖ CREATE NEW CLIENT
  console.log("üìù Creating new client");

  const response = await fetch(`${API_BASE_URL}/api/clients`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      password,
      name,
      phoneNumberTarget,
      service,
      adminId: operatorID
    })
  });

  const data = await response.json();

  if (response.ok) {
    alert("‚úÖ Client berhasil ditambahkan!");
    closeModal("addUserModal");
    loadClients();
  } else {
    throw new Error(data.error || "Failed to add client");
  }
}

            } catch (error) {
                console.error("‚ùå Form submission error:", error);
                alert("‚ùå Error: " + error.message);
            } finally {
                submitBtn.dataset.loading = "false";
                submitBtn.disabled = false;
                submitBtn.style.opacity = "1";
                submitBtn.innerText = "DEPLOY METADATA";
            }
        };

        // Initialize the app
        initApp();
    </script>
</body>
</html>
